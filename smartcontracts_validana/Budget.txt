Type: Budget
Version: 1.0
Description: Duo past budget voor subsidie aan.
Template: {"jaar":{"type":"uint","desc":"Het jaar waarvoor budget beschikbaar is.","name":"Jaar"},"sector":{"type":"str","desc":"Voor welke sector het beschikbaar is.","name":"Sector"},"budgetTotaal":{"type":"float","desc":"Budget wat er totaal beschikbaar is voor deze sector.","name":"Budget totaal"},"budgetVervolg":{"type":"float","desc":"Welk gedeelte van dit budget voor vervolg aanvragen is.","name":"Budget vervolg"}}
Init: YXdhaXQgcXVlcnkoIkNSRUFURSIsICJidWRnZXQiLCAiKGphYXIgSU5ULCBzZWN0b3IgVkFSQ0hBUigzMiksIGJlc2NoaWtiYWFyX3RvdGFhbF9jZW50ZW4gQklHSU5UIE5PVCBOVUxMLCAiICsKICAgICJiZXNjaGlrYmFhcl92ZXJ2b2xnX2NlbnRlbiBCSUdJTlQgTk9UIE5VTEwsIHVpdGdlZ2V2ZW5fdG90YWFsX2NlbnRlbiBCSUdJTlQgTk9UIE5VTEwgREVGQVVMVCAwLCAiICsKICAgICJ1aXRnZWdldmVuX3ZlcnZvbGdfY2VudGVuIEJJR0lOVCBOT1QgTlVMTCBERUZBVUxUIDAsIFBSSU1BUlkgS0VZIChqYWFyLCBzZWN0b3IpKTsiLCBbXSk7
Code: aWYgKHBheWxvYWQuamFhciA+IDIxNDc0ODM2NDcpIHsKICAgIHJldHVybiAiT25nZWxkaWcgamFhci4iOwp9CmNvbnN0IG5pZXV3VG90YWFsQ2VudGVuID0gTWF0aC5yb3VuZChwYXlsb2FkLmJ1ZGdldFRvdGFhbCAqIDEwMCk7CmNvbnN0IG5pZXV3VmVydm9sZ0NlbnRlbiA9IE1hdGgucm91bmQocGF5bG9hZC5idWRnZXRWZXJ2b2xnICogMTAwKTsKaWYgKG5pZXV3VG90YWFsQ2VudGVuIDwgMCB8fCBuaWV1d1ZlcnZvbGdDZW50ZW4gPCAwIHx8IG5pZXV3VG90YWFsQ2VudGVuID09PSBJbmZpbml0eSB8fCBuaWV1d1ZlcnZvbGdDZW50ZW4gPT09IEluZmluaXR5IHx8CiAgICBuaWV1d1RvdGFhbENlbnRlbiA8IG5pZXV3VmVydm9sZ0NlbnRlbikgewogICAgcmV0dXJuICJPbmdlbGRpZ2UgYnVkZ2V0IjsKfQpjb25zdCBzZWN0b3IgPSBwYXlsb2FkLnNlY3RvcjsKaWYgKHNlY3RvciAhPT0gIlZPIiAmJiBzZWN0b3IgIT09ICJCVkUiICYmIHNlY3RvciAhPT0gIkhCTyIgJiYgc2VjdG9yICE9PSAiUE9lblBTT2VuVlNPIikgewogICAgcmV0dXJuICJPbmdlbGRpZ2Ugc2VjdG9yIjsKfQovL0FsbGVlbiBkdW8gbWFnIGJ1ZGdldCBhYW5wYXNzZW4KY29uc3QgZHVvID0gKGF3YWl0IHF1ZXJ5KCJTRUxFQ1QiLCAiZW50aXRlaXRlbiIsICJXSEVSRSBpZCA9ICdEVU8nOyIsIFtdKSkucm93c1swXTsKaWYgKGR1byA9PT0gdW5kZWZpbmVkIHx8IGZyb20gIT09IGR1by5hZGRyZXNzKSB7CiAgICByZXR1cm4gIk9uZ2VsZGlnZSBnZWJydWlrZXIiOwp9CmNvbnN0IGh1aWRpZ0J1ZGdldCA9IChhd2FpdCBxdWVyeSgiU0VMRUNUIiwgImJ1ZGdldCIsICJXSEVSRSBqYWFyID0gJDEgQU5EIHNlY3RvciA9ICQyOyIsIFtwYXlsb2FkLmphYXIsIHNlY3Rvcl0pKS5yb3dzWzBdOwppZiAoaHVpZGlnQnVkZ2V0ICE9PSB1bmRlZmluZWQpIHsKICAgIGNvbnN0IHRvdGFhbFZlcmFuZGVyaW5nID0gbmlldXdUb3RhYWxDZW50ZW4gLSBodWlkaWdCdWRnZXQuYmVzY2hpa2JhYXJfdG90YWFsX2NlbnRlbjsKICAgIGNvbnN0IHZlcnZvbGdWZXJhbmRlcmluZyA9IG5pZXV3VmVydm9sZ0NlbnRlbiAtIGh1aWRpZ0J1ZGdldC5iZXNjaGlrYmFhcl92ZXJ2b2xnX2NlbnRlbjsKICAgIC8vQWxzIGJ1ZGdldCB2ZXJsYWFndCBraWprIG9mIGVyIG5vZyBnZW5vZWcgYmVzY2hpa2JhYXIgemFsIHppam4KICAgIGlmIChodWlkaWdCdWRnZXQuYmVzY2hpa2JhYXJfdG90YWFsX2NlbnRlbiAtIHRvdGFhbFZlcmFuZGVyaW5nIDwgMCkgewogICAgICAgIHJldHVybiAiQWxyZWVkcyB0ZXZlZWwgdWl0Z2VnZXZlbiwga2FuIHRvdGFhbCBidWRnZXQgbm9nIHZlcmxhZ2VuIHRvdCDigqwiICsKICAgICAgICAgICAgKGh1aWRpZ0J1ZGdldC5iZXNjaGlrYmFhcl90b3RhYWxfY2VudGVuIC0gaHVpZGlnQnVkZ2V0LnVpdGdlZ2V2ZW5fdG90YWFsX2NlbnRlbikgLyAxMDA7CiAgICB9CiAgICBpZiAoaHVpZGlnQnVkZ2V0LmJlc2NoaWtiYWFyX3ZlcnZvbGdfY2VudGVuIC0gdmVydm9sZ1ZlcmFuZGVyaW5nIDwgMCkgewogICAgICAgIHJldHVybiAiQWxyZWVkcyB0ZXZlZWwgdWl0Z2VnZXZlbiwga2FuIHZlcnZvbGcgYnVkZ2V0IG5vZyB2ZXJsYWdlbiB0b3Qg4oKsIiArCiAgICAgICAgICAgIChodWlkaWdCdWRnZXQuYmVzY2hpa2JhYXJfdmVydm9sZ19jZW50ZW4gLSBodWlkaWdCdWRnZXQudWl0Z2VnZXZlbl92ZXJ2b2xnX2NlbnRlbikgLyAxMDA7CiAgICB9CiAgICAvL0J1ZGdldCBvcGhvZ2VuCiAgICBhd2FpdCBxdWVyeSgiVVBEQVRFIiwgImJ1ZGdldCIsICJTRVQgYmVzY2hpa2JhYXJfdG90YWFsX2NlbnRlbiA9ICQzLCBiZXNjaGlrYmFhcl92ZXJ2b2xnX2NlbnRlbiA9ICQ0ICIgKwogICAgICAgICJXSEVSRSBqYWFyID0gJDEgQU5EIHNlY3RvciA9ICQyOyIsIFtwYXlsb2FkLmphYXIsIHNlY3RvciwgbmlldXdUb3RhYWxDZW50ZW4sIG5pZXV3VmVydm9sZ0NlbnRlbl0pOwp9CmVsc2UgewogICAgLy9OaWV1dyBidWRnZXQgdG9ldm9lZ2VuCiAgICBhd2FpdCBxdWVyeSgiSU5TRVJUIiwgImJ1ZGdldCIsICIoamFhciwgc2VjdG9yLCBiZXNjaGlrYmFhcl90b3RhYWxfY2VudGVuLCBiZXNjaGlrYmFhcl92ZXJ2b2xnX2NlbnRlbikgVkFMVUVTICgkMSwgJDIsICQzLCAkNCk7IiwgW3BheWxvYWQuamFhciwgc2VjdG9yLCBuaWV1d1RvdGFhbENlbnRlbiwgbmlldXdWZXJ2b2xnQ2VudGVuXSk7Cn0KcmV0dXJuICJPSyI7

Init as text:
await query("CREATE", "budget", "(jaar INT, sector VARCHAR(32), beschikbaar_totaal_centen BIGINT NOT NULL, " +
    "beschikbaar_vervolg_centen BIGINT NOT NULL, uitgegeven_totaal_centen BIGINT NOT NULL DEFAULT 0, " +
    "uitgegeven_vervolg_centen BIGINT NOT NULL DEFAULT 0, PRIMARY KEY (jaar, sector));", []);
Code as text:
if (payload.jaar > 2147483647) {
    return "Ongeldig jaar.";
}
const nieuwTotaalCenten = Math.round(payload.budgetTotaal * 100);
const nieuwVervolgCenten = Math.round(payload.budgetVervolg * 100);
if (nieuwTotaalCenten < 0 || nieuwVervolgCenten < 0 || nieuwTotaalCenten === Infinity || nieuwVervolgCenten === Infinity ||
    nieuwTotaalCenten < nieuwVervolgCenten) {
    return "Ongeldige budget";
}
const sector = payload.sector;
if (sector !== "VO" && sector !== "BVE" && sector !== "HBO" && sector !== "POenPSOenVSO") {
    return "Ongeldige sector";
}
//Alleen duo mag budget aanpassen
const duo = (await query("SELECT", "entiteiten", "WHERE id = 'DUO';", [])).rows[0];
if (duo === undefined || from !== duo.address) {
    return "Ongeldige gebruiker";
}
const huidigBudget = (await query("SELECT", "budget", "WHERE jaar = $1 AND sector = $2;", [payload.jaar, sector])).rows[0];
if (huidigBudget !== undefined) {
    const totaalVerandering = nieuwTotaalCenten - huidigBudget.beschikbaar_totaal_centen;
    const vervolgVerandering = nieuwVervolgCenten - huidigBudget.beschikbaar_vervolg_centen;
    //Als budget verlaagt kijk of er nog genoeg beschikbaar zal zijn
    if (huidigBudget.beschikbaar_totaal_centen - totaalVerandering < 0) {
        return "Alreeds teveel uitgegeven, kan totaal budget nog verlagen tot €" +
            (huidigBudget.beschikbaar_totaal_centen - huidigBudget.uitgegeven_totaal_centen) / 100;
    }
    if (huidigBudget.beschikbaar_vervolg_centen - vervolgVerandering < 0) {
        return "Alreeds teveel uitgegeven, kan vervolg budget nog verlagen tot €" +
            (huidigBudget.beschikbaar_vervolg_centen - huidigBudget.uitgegeven_vervolg_centen) / 100;
    }
    //Budget ophogen
    await query("UPDATE", "budget", "SET beschikbaar_totaal_centen = $3, beschikbaar_vervolg_centen = $4 " +
        "WHERE jaar = $1 AND sector = $2;", [payload.jaar, sector, nieuwTotaalCenten, nieuwVervolgCenten]);
}
else {
    //Nieuw budget toevoegen
    await query("INSERT", "budget", "(jaar, sector, beschikbaar_totaal_centen, beschikbaar_vervolg_centen) VALUES ($1, $2, $3, $4);", [payload.jaar, sector, nieuwTotaalCenten, nieuwVervolgCenten]);
}
return "OK";