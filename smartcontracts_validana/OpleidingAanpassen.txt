Type: OpleidingAanpassen
Version: 1.0
Description: Opleider past de eigenschappen van een opleiding aan.
Template: {"opleiding":{"type":"hash","desc":"De opleiding om aan te passen.","name":"Opleiding"},"eigenschappen":{"type":"json","desc":"Aanpassingen.","name":"Aanpassingen"}}
Init: 
Code: Ly9IdWlkaWdlIGVpZ2Vuc2NoYXBwZW4KY29uc3QgYmluYXJ5T3BsZWlkaW5nID0gQnVmZmVyLmZyb20ocGF5bG9hZC5vcGxlaWRpbmcsICJoZXgiKTsKY29uc3Qgb3BsZWlkaW5nID0gKGF3YWl0IHF1ZXJ5KCJTRUxFQ1QiLCAib3BsZWlkaW5nZW4iLCAiV0hFUkUgaWQgPSAkMTsiLCBbYmluYXJ5T3BsZWlkaW5nXSkpLnJvd3NbMF07CmlmIChvcGxlaWRpbmcgPT09IHVuZGVmaW5lZCkgewogICAgcmV0dXJuICJPcGxlaWRpbmcgYmVzdGFhdCBuaWV0LiI7Cn0KLy9BbGxlZW4gb3BsZWlkZXIgbWFnIGRvY2VudGVuIGFhbnBhc3NlbiBvcCBzb21taWdlIHZlbGRlbgpjb25zdCBvcGxlaWRlckNoZWNrID0gKCkgPT4gewogICAgcmV0dXJuIG9wbGVpZGluZy5vcGxlaWRlciA9PT0gZnJvbTsKfTsKLy9BbGxlZW4gZHVvIG1hZyBkb2NlbnRlbiBhYW5wYXNzZW4gb3Agc29tbWlnZSB2ZWxkZW4KbGV0IGlzRHVvOwpjb25zdCBkdW9DaGVjayA9IGFzeW5jICgpID0+IHsKICAgIGlmIChpc0R1byA9PT0gdW5kZWZpbmVkKSB7CiAgICAgICAgY29uc3QgZHVvID0gKGF3YWl0IHF1ZXJ5KCJTRUxFQ1QiLCAiZW50aXRlaXRlbiIsICJXSEVSRSBpZCA9ICdEVU8nOyIsIFtdKSkucm93c1swXTsKICAgICAgICBpc0R1byA9IGR1byAhPT0gdW5kZWZpbmVkICYmIGR1by5hZGRyZXNzID09PSBmcm9tOwogICAgfQogICAgcmV0dXJuIGlzRHVvOwp9OwovL05pZXV3ZSBlaWdlbnNjaGFwcGVuCmNvbnN0IG5ld1NldHRpbmdzID0gSlNPTi5wYXJzZShwYXlsb2FkLmVpZ2Vuc2NoYXBwZW4pOwppZiAodHlwZW9mIG5ld1NldHRpbmdzICE9PSAib2JqZWN0IiB8fCBuZXdTZXR0aW5ncyA9PT0gbnVsbCkgewogICAgcmV0dXJuICJPbmdlbGRpZ2UgZWlnZW5zY2hhcHBlbiI7Cn0KLy9LaWprIG9mIGFhbmdlcGFzdGUgZWlnZW5zY2hhcHBlbiBkb29yIGRlIGp1aXN0ZSBnZWJydWlrZXIgd29yZGVuIGFhbmdlcGFzdCBlbiBnZWxkaWcgemlqbgpmb3IgKGNvbnN0IGtleSBvZiBPYmplY3Qua2V5cyhuZXdTZXR0aW5ncykpIHsKICAgIHN3aXRjaCAoa2V5KSB7CiAgICAgICAgLy9VQzEuUjQKICAgICAgICBjYXNlICJiYWNoZWxvciI6IC8vQjAwNC5CUjAyLjEgJiBCNDAyLkJSMDIuMgogICAgICAgIGNhc2UgIm1hc3RlciI6IC8vQjAwNC5CUjAyLjIgJiBCNDAyLkJSMDIuMgogICAgICAgIGNhc2UgImRlZmljacOrbnRpZW9wbGVpZGluZyI6IC8vQjAwNC5CUjAyLjMgJiBCNDAyLkJSMDIuMgogICAgICAgICAgICBpZiAodHlwZW9mIG5ld1NldHRpbmdzW2tleV0gIT09ICJib29sZWFuIiB8fCAhb3BsZWlkZXJDaGVjaygpIHx8IG9wbGVpZGluZy5laWdlbnNjaGFwcGVuLmFhbnBhc3NlblN0YXAgPT09IDIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAiT25nZWxkaWdlIGVpZ2Vuc2NoYXBwZW4gb2YgZ2VicnVpa2VyIG9mIG1hZyBuaWV0IG1lZXIgYWFucGFzc2VuIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIG9wbGVpZGluZy5laWdlbnNjaGFwcGVuLmFhbnBhc3NlblN0YXAgPSAxOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGJyZWFrOwogICAgICAgIGNhc2UgIkVDIjogLy9CMDAzLkJSMDIgJiBCMDAzLkJSMDcKICAgICAgICAvL1VDMi5SMSAmIFVDMy5SMwogICAgICAgIGNhc2UgImNvbGxlZ2VHZWxkQ2VudGVuIjogLy9CMDA2LkJSMDIuMSAmIEI0MDEuQlIwMi4yCiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3U2V0dGluZ3Nba2V5XSAhPT0gIm51bWJlciIgfHwgbmV3U2V0dGluZ3Nba2V5XSA+IDIxNDc0ODM2NDcgfHwKICAgICAgICAgICAgICAgICFvcGxlaWRlckNoZWNrKCkgfHwgb3BsZWlkaW5nLmVpZ2Vuc2NoYXBwZW4uYWFucGFzc2VuU3RhcCA9PT0gMikgewogICAgICAgICAgICAgICAgcmV0dXJuICJPbmdlbGRpZ2UgZWlnZW5zY2hhcHBlbiBvZiBnZWJydWlrZXIgb2YgbWFnIG5pZXQgbWVlciBhYW5wYXNzZW4iOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgb3BsZWlkaW5nLmVpZ2Vuc2NoYXBwZW4uYWFucGFzc2VuU3RhcCA9IDE7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgLy9VQzEuUjUKICAgICAgICBjYXNlICJpbk5lZGVybGFuZCI6IC8vQjAwNC5CUjAzLjEKICAgICAgICBjYXNlICJpbkVVIjogLy9CMDA0LkJSMDMuMgogICAgICAgIGNhc2UgImluQXJ1YmEiOiAvL0IwMDQuQlIwMy4zCiAgICAgICAgY2FzZSAiaW5TaW50TWFhcnRlbiI6IC8vQjAwNC5CUjAzLjQKICAgICAgICBjYXNlICJpbkN1cmHDp2FvIjogLy9CMDA0LkJSMDMuNQogICAgICAgIGNhc2UgIk51ZmZpY0dlbGlqa3dhYXJkaWdWZXJrbGFhcmRlQnVpdGVubGFuZHMiOiAvL0IwMDQuQlIwNC4xCiAgICAgICAgY2FzZSAiTlZPZ2VhY2NyZWRpdGVlcmQiOiAvL0IwMDQuQlIwNC4yCiAgICAgICAgICAgIGlmICh0eXBlb2YgbmV3U2V0dGluZ3Nba2V5XSAhPT0gImJvb2xlYW4iIHx8ICFhd2FpdCBkdW9DaGVjaygpIHx8IG9wbGVpZGluZy5laWdlbnNjaGFwcGVuLmFhbnBhc3NlblN0YXAgPT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICJPbmdlbGRpZ2UgZWlnZW5zY2hhcHBlbiBvZiBnZWJydWlrZXIgb2YgbWFnIG5vZyBuaWV0IGFhbnBhc3NlbiI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBvcGxlaWRpbmcuZWlnZW5zY2hhcHBlbi5hYW5wYXNzZW5TdGFwID0gMjsKICAgICAgICAgICAgfQogICAgICAgICAgICBicmVhazsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gIk9uZ2VsZGlnZSBlaWdlbnNjaGFwIjsKICAgIH0KfQovL0VpZ2Vuc2NoYXBwZW4gdXBkYXRlbgpPYmplY3QuYXNzaWduKG9wbGVpZGluZy5laWdlbnNjaGFwcGVuLCBuZXdTZXR0aW5ncyk7CmF3YWl0IHF1ZXJ5KCJVUERBVEUiLCAib3BsZWlkaW5nZW4iLCAiU0VUIGVpZ2Vuc2NoYXBwZW4gPSAkMiBXSEVSRSBpZCA9ICQxOyIsIFtiaW5hcnlPcGxlaWRpbmcsIEpTT04uc3RyaW5naWZ5KG9wbGVpZGluZy5laWdlbnNjaGFwcGVuKV0pOwpyZXR1cm4gIk9LIjs=

Init as text:

Code as text:
//Huidige eigenschappen
const binaryOpleiding = Buffer.from(payload.opleiding, "hex");
const opleiding = (await query("SELECT", "opleidingen", "WHERE id = $1;", [binaryOpleiding])).rows[0];
if (opleiding === undefined) {
    return "Opleiding bestaat niet.";
}
//Alleen opleider mag docenten aanpassen op sommige velden
const opleiderCheck = () => {
    return opleiding.opleider === from;
};
//Alleen duo mag docenten aanpassen op sommige velden
let isDuo;
const duoCheck = async () => {
    if (isDuo === undefined) {
        const duo = (await query("SELECT", "entiteiten", "WHERE id = 'DUO';", [])).rows[0];
        isDuo = duo !== undefined && duo.address === from;
    }
    return isDuo;
};
//Nieuwe eigenschappen
const newSettings = JSON.parse(payload.eigenschappen);
if (typeof newSettings !== "object" || newSettings === null) {
    return "Ongeldige eigenschappen";
}
//Kijk of aangepaste eigenschappen door de juiste gebruiker worden aangepast en geldig zijn
for (const key of Object.keys(newSettings)) {
    switch (key) {
        //UC1.R4
        case "bachelor": //B004.BR02.1 & B402.BR02.2
        case "master": //B004.BR02.2 & B402.BR02.2
        case "deficiëntieopleiding": //B004.BR02.3 & B402.BR02.2
            if (typeof newSettings[key] !== "boolean" || !opleiderCheck() || opleiding.eigenschappen.aanpassenStap === 2) {
                return "Ongeldige eigenschappen of gebruiker of mag niet meer aanpassen";
            }
            else {
                opleiding.eigenschappen.aanpassenStap = 1;
            }
            break;
        case "EC": //B003.BR02 & B003.BR07
        //UC2.R1 & UC3.R3
        case "collegeGeldCenten": //B006.BR02.1 & B401.BR02.2
            if (typeof newSettings[key] !== "number" || newSettings[key] > 2147483647 ||
                !opleiderCheck() || opleiding.eigenschappen.aanpassenStap === 2) {
                return "Ongeldige eigenschappen of gebruiker of mag niet meer aanpassen";
            }
            else {
                opleiding.eigenschappen.aanpassenStap = 1;
            }
            break;
        //UC1.R5
        case "inNederland": //B004.BR03.1
        case "inEU": //B004.BR03.2
        case "inAruba": //B004.BR03.3
        case "inSintMaarten": //B004.BR03.4
        case "inCuraçao": //B004.BR03.5
        case "NufficGelijkwaardigVerklaardeBuitenlands": //B004.BR04.1
        case "NVOgeaccrediteerd": //B004.BR04.2
            if (typeof newSettings[key] !== "boolean" || !await duoCheck() || opleiding.eigenschappen.aanpassenStap === undefined) {
                return "Ongeldige eigenschappen of gebruiker of mag nog niet aanpassen";
            }
            else {
                opleiding.eigenschappen.aanpassenStap = 2;
            }
            break;
        default:
            return "Ongeldige eigenschap";
    }
}
//Eigenschappen updaten
Object.assign(opleiding.eigenschappen, newSettings);
await query("UPDATE", "opleidingen", "SET eigenschappen = $2 WHERE id = $1;", [binaryOpleiding, JSON.stringify(opleiding.eigenschappen)]);
return "OK";